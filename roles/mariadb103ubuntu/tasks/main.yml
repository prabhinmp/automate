---
# tasks file for mariadb103ubuntu
- name: check mysql already installed or not
  command: mysql --version
  ignore_errors: true
  register: mysql_exist
- name: remove existing mysql
  package:
    name: "{{ item }}"
    purge: yes
    state: absent
  with_items: "{{remove_package}}"
  when: mysql_exist.rc == 0
- name: install dependency package
  apt: name=software-properties-common state=present update_cache=true
- name: add the GPG key
  command: apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
- name: add repositories
  apt_repository:
    repo: deb [arch=amd64,arm64,i386,ppc64el] http://ftp.kaist.ac.kr/mariadb/repo/10.3/ubuntu xenial main
    state: present
    filename: mariadb
#- name: Set MySQL root password before installing
#  command: debconf-set-selections <<< 'mariadb-server-10.3 mysql-server/root_password password {{ mariadb_root_password }}'
#- name: Confirm MySQL root password before installing
#  command: debconf-set-selections <<< 'mariadb-server-10.3 mysql-server/root_password_again password {{ mariadb_root_password }}'
- name: install mariadb 10.3 in ubuntu
  package:
    name: "{{ item }}"
    state: present
    update_cache: true
  with_items: "{{mariadb_packages}}"
- name: mysql root user Creatation
  mysql_user:
    name: root
    password: "{{ mariadb_root_password }}"
    host: "{{ item }}"
    priv: '*.*:ALL,GRANT'
    state: present
  with_items:
    - ::1
    - localhost
    - '%'
    - 127.0.0.1
- name: remove
- mysql_user:
    name: ''
    host_all: yes
    state: absent

#  notify:
#    - start
#- name: Update MySQL root password for all root accounts
#  mysql_user:
#      login_user: root
#      login_password: "{{ mariadb_root_password}}"
#      check_implicit_admin: yes
#      name: root
#      host_all: yes
#    #  host: "{{ item }}"

#      password: "{{ mariadb_root_password }}"
#      state: present
#  with_items:
#      - ::1
#      - localhost
#      - 127.0.0.1
#      - '%'

#- name: replace bind address
#  lineinfile:
#    dest: /etc/mysql/my.cnf
#    regexp: '^(.*)bind-address(.*)$'
#    line: bind-address            = {{ ansible_default_ipv4.address }}
#    backrefs: yes
#  become: true
#  notify:
#    - start
